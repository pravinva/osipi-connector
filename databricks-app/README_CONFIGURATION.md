# Mock PI Server - Configuration UI

## Overview

The mock PI Web API server now includes a web-based configuration interface that allows you to dynamically adjust the number of tags, AF hierarchy elements, event frames, and alarms without redeploying the application.

## Accessing the Configuration UI

**URL**: `https://osipi-webserver-1444828305810485.aws.databricksapps.com/config`

Or from the home page, click **Configuration** in the Quick Links section.

## Configuration Options

### 1. Number of PI Tags
**Range**: 10 - 100,000 tags

Controls the total number of PI tags generated by the mock server.

**Formula**: `plants × units × 8 sensor types = total tags`

**Automatic Scaling**:
- **128 tags** (Demo): 4 plants × 4 units × 8 sensors
- **1,040 tags** (Small): 10 plants × 13 units × 8 sensors
- **10,000 tags** (Medium): 25 plants × 50 units × 8 sensors
- **30,000 tags** (Large): 60 plants × 63 units × 8 sensors

**Sensor Types**:
- Temperature (°C)
- Pressure (bar)
- Flow (m³/h)
- Level (%)
- Power (kW)
- Speed (RPM)
- Voltage (V)
- Current (A)

### 2. AF Hierarchy (Asset Framework)
**Automatically scaled based on tag count**

The AF hierarchy is generated with a realistic industrial structure:
- **Database** → **Plants** → **Units** → **Equipment**

**Performance Optimization**: For tag counts > 10,000, AF hierarchy is limited to the first 10 plants and 10 units to maintain fast API response times.

**Structure**:
```
ProductionDB (F1DP-DB-Production)
├── Eraring_Plant
│   ├── Unit_1
│   │   ├── Pump_101
│   │   ├── Compressor_101
│   │   ├── HeatExchanger_101
│   │   └── Reactor_101
│   ├── Unit_2
│   └── Unit_3...
├── Bayswater_Plant
└── ...
```

### 3. Number of Event Frames
**Range**: 10 - 10,000 events

Controls the number of event frames (batch runs, alarms, maintenance) generated.

**Event Types**:
- **Batch Runs**: Production batches with product, operator, quantities
- **Maintenance**: Scheduled/unscheduled maintenance with work orders
- **Alarms**: Process/equipment/safety alarms with severity levels
- **Downtime**: Unplanned downtime events

### 4. Event History (Days)
**Range**: 1 - 365 days

Controls how far back in time events are generated.

**Example**: Setting to 30 days generates events randomly distributed over the past month.

## Preset Configurations

Quick-select buttons for common configurations:

| Preset | Tags | Use Case | Response Time |
|--------|------|----------|---------------|
| **Demo** | 128 | Demos, quick testing | < 100ms |
| **Small** | 1,040 | Development | ~500ms |
| **Medium** | 10,000 | Integration testing | ~1s |
| **Large** | 30,000 | Production-scale testing | 2-3s |

## Configuration Calculator

The UI includes a real-time calculator that shows:
- **Calculated Tags**: Actual tag count based on input
- **Calculated AF Elements**: Total AF hierarchy elements
- **Calculated Plants**: Number of facilities
- **Est. Response Time**: Expected API response time

## How It Works

### Backend API

**Endpoint**: `POST /api/config/update`

**Request Body**:
```json
{
  "tag_count": 1040,
  "event_count": 100,
  "event_days": 30
}
```

**Response**:
```json
{
  "success": true,
  "tags": 1040,
  "af_elements": 650,
  "events": 100,
  "plants": 10
}
```

### Data Regeneration Process

When you submit a configuration update:

1. **Validation**: Input values are validated against allowed ranges
2. **Clear Existing Data**: Current mock data is cleared from memory
3. **Regenerate Tags**: New tags are generated with unique WebIDs
4. **Regenerate AF Hierarchy**: Plant/unit/equipment structure is rebuilt
5. **Regenerate Event Frames**: New events with random timestamps
6. **Immediate Effect**: All API endpoints immediately return new data

**No restart required** - changes take effect instantly.

## Plant Names

The mock server uses real Australian energy facility names:

**Power Stations**:
- Loy Yang A/B, Yallourn, Eraring, Bayswater
- Mount Piper, Vales Point, Stanwell, Kogan Creek
- Callide, Gladstone, Tarong, Millmerran

**Renewable Energy**:
- Hornsdale Wind, Capital Wind, Snowtown Wind
- Broken Hill Solar, Nyngan Solar, Moree Solar

**Hydro Power**:
- Snowy Hydro, Tumut 1/2/3, Murray 1/2
- Blowering, Gordon, Poatina

**Mining & Resources**:
- Olympic Dam, Mount Isa Copper, Bowen Basin
- Pilbara Iron Ore, Kalgoorlie Gold

## Performance Impact

| Configuration | API Response Time | Memory Usage | Use Case |
|---------------|------------------|--------------|----------|
| 128-1K tags | < 500ms | Low | Demos, development |
| 10K tags | ~1s | Medium | Integration testing |
| 30K+ tags | 2-3s | High | Production-scale testing |

## Example Use Cases

### Quick Demo Setup (128 tags)
1. Click **Demo (128 tags)** preset
2. Click **Apply Configuration**
3. Ready for demo in < 1 second

### Integration Testing (1K tags)
1. Set **Number of PI Tags**: 1000
2. Set **Number of Event Frames**: 200
3. Set **Event History**: 7 days
4. Click **Apply Configuration**
5. Use for connector testing

### Production-Scale Testing (30K tags)
1. Click **Large (30K tags)** preset
2. Adjust event frames as needed
3. Click **Apply Configuration**
4. Test at scale with 2-3s API response times

## Integration with Pipeline Generator

After updating the configuration, regenerate pipelines using the notebook:

```python
# notebooks/generate_pipelines_from_mock_api.py

# Configuration (adjust as needed)
MAX_TAGS_TO_FETCH = None  # Fetch all tags from mock API
TAGS_PER_PIPELINE = 100    # 100 tags per pipeline
AUTO_DEPLOY_DAB = True     # Auto-deploy after generation

# Run notebook - it will:
# 1. Discover tags from /config endpoint
# 2. Group by priority (Temperature/Pressure=high, Flow/Level=medium, etc.)
# 3. Generate DAB YAML files
# 4. Deploy to Databricks
```

## API Endpoints Affected

All PI Web API endpoints are affected by configuration changes:

- `/piwebapi/dataservers/{server_id}/points` - Returns new tag list
- `/piwebapi/streams/{webid}/recorded` - Returns data for new tags
- `/piwebapi/assetdatabases/{db_id}/elements` - Returns new AF hierarchy
- `/piwebapi/assetdatabases/{db_id}/eventframes` - Returns new event frames

## Troubleshooting

### Configuration Not Taking Effect
- **Cause**: Browser cache
- **Solution**: Hard refresh (Ctrl+Shift+R or Cmd+Shift+R)

### API Returns Old Tag Count
- **Cause**: The configuration updated correctly, but you're querying cached results
- **Solution**: Wait a few seconds and retry

### Configuration Update Returns Error
- **Cause**: Input values out of range
- **Solution**: Check validation rules (10-100K tags, 10-10K events, 1-365 days)

## Technical Details

### Data Generation Logic

The configuration endpoint replicates the exact logic from `tests/mock_pi_server.py`:

1. **Calculate Plants/Units**: Determines optimal plant and unit count to reach target tags
2. **Generate Tags**: Creates tags in format `{Plant}_Unit{XXX}_{SensorType}_PV`
3. **Generate AF Hierarchy**: Creates 4-level structure (DB → Plant → Unit → Equipment)
4. **Generate Events**: Creates random events over specified time range
5. **In-Memory Storage**: All data stored in Python dictionaries for fast access

### No Database Required

The mock server stores all configuration in memory:
- Fast read/write access
- No database setup needed
- Resets to default (128 tags) on app restart

To persist configuration across restarts, set the `MOCK_PI_TAG_COUNT` environment variable in the Databricks App configuration.

## Next Steps

After configuring the mock server:

1. **Test API Endpoints**: Verify tag count, AF hierarchy, events
2. **Run Connector Notebook**: Ingest data into osipi.bronze tables
3. **Generate Pipelines**: Create DAB pipelines for your tag configuration
4. **Deploy Pipelines**: Deploy to Databricks using DAB
5. **Monitor Dashboard**: Check `/ingestion` for real-time ingestion status
